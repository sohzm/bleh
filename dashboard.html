<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>bleh</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: Arial, Helvetica, sans-serif;
      font-size: 13px;
      background: #fff;
      color: #333;
    }

    input, select, textarea, button { font-family: Arial, Helvetica, sans-serif; font-size: 12px; }

    a, .lnk {
      color: #00008b;
      cursor: pointer;
      background: none;
      border: none;
      padding: 0;
      font-size: inherit;
      text-decoration: underline;
      font-family: inherit;
    }
    a:hover, .lnk:hover { color: #0000cc; }
    .lnk-red { color: #990000; }
    .lnk-red:hover { color: #cc0000; }

    /* ── Auth page ──────────────────────────────────────────────────────── */
    #auth-page {
      min-height: 100vh;
      background: #f0f0f0;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 80px;
    }

    #auth-box {
      width: 340px;
      background: #fff;
      border: 1px solid #bbb;
      padding: 24px 20px;
    }

    #auth-box h2 { font-size: 15px; margin-bottom: 4px; }
    #auth-box .sub { color: #888; font-size: 11px; margin-bottom: 18px; }

    .arow { margin-bottom: 10px; }
    .arow label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 3px; }
    .arow input[type=password] {
      width: 100%;
      border: 1px solid #aaa;
      padding: 5px 6px;
    }
    .arow input:focus { border-color: #666; outline: none; }

    .abtn {
      background: #6e45a2;
      color: #fff;
      border: 1px solid #5a3688;
      padding: 5px 14px;
      cursor: pointer;
      font-size: 12px;
      margin-top: 4px;
    }
    .abtn:hover { background: #5a3688; }

    .err { color: #cc0000; font-size: 12px; margin-top: 8px; }

    /* ── App ────────────────────────────────────────────────────────────── */
    #topbar {
      background: #6e45a2;
      color: #fff;
      padding: 6px 12px;
      display: flex;
      align-items: baseline;
      gap: 10px;
    }
    #topbar .site-name { font-size: 20px; font-weight: bold; }
    #topbar .sep { color: #b89ad4; }
    #topbar .tlink {
      color: #e0d0f5;
      text-decoration: none;
      font-size: 12px;
      cursor: pointer;
      background: none;
      border: none;
      font-family: inherit;
    }
    #topbar .tlink:hover { text-decoration: underline; color: #fff; }
    #topbar .tlink.new { font-weight: bold; color: #fff; }

    #main { padding: 12px 14px; }

    #route-count { font-size: 12px; color: #888; margin-bottom: 6px; }

    /* ── Routes table ───────────────────────────────────────────────────── */
    table.rtbl { border-collapse: collapse; width: 100%; margin-top: 6px; }
    table.rtbl th {
      background: #efefef;
      border: 1px solid #ccc;
      padding: 4px 8px;
      text-align: left;
      font-size: 11px;
      white-space: nowrap;
    }
    table.rtbl td {
      border: 1px solid #ddd;
      padding: 5px 8px;
      vertical-align: middle;
    }
    table.rtbl tbody tr:hover td { background: #f5f0ff; }

    .m-GET    { color: #006600; font-weight: bold; font-size: 11px; }
    .m-POST   { color: #000099; font-weight: bold; font-size: 11px; }
    .m-PUT    { color: #885500; font-weight: bold; font-size: 11px; }
    .m-DELETE { color: #990000; font-weight: bold; font-size: 11px; }
    .m-PATCH  { color: #660066; font-weight: bold; font-size: 11px; }

    .empty-row td { color: #888; font-style: italic; text-align: center; padding: 20px; }

    /* ── Modal ──────────────────────────────────────────────────────────── */
    .modal-bg {
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding-top: 40px;
      z-index: 100;
    }

    .modal {
      background: #fff;
      border: 1px solid #666;
      width: 680px;
      max-height: 88vh;
      overflow-y: auto;
    }

    .modal-head {
      background: #efefef;
      border-bottom: 1px solid #ccc;
      padding: 7px 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky; top: 0; z-index: 1;
    }
    .modal-head h3 { font-size: 13px; margin: 0; }
    .modal-x {
      background: none; border: none;
      color: #666; cursor: pointer;
      font-size: 18px; line-height: 1;
    }
    .modal-x:hover { color: #000; }

    .modal-body { padding: 14px; }

    .modal-foot {
      border-top: 1px solid #ccc;
      padding: 8px 12px;
      background: #fafafa;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky; bottom: 0; z-index: 1;
    }
    .modal-foot .foot-right { display: flex; gap: 8px; align-items: center; }

    /* ── Forms ──────────────────────────────────────────────────────────── */
    .frow { margin-bottom: 12px; }
    .frow label { display: block; font-weight: bold; font-size: 11px; margin-bottom: 3px; }
    .frow input[type=text],
    .frow input[type=number],
    .frow select {
      border: 1px solid #aaa;
      padding: 4px 6px;
      background: #fff;
      width: 100%;
    }
    .frow input:focus, .frow select:focus { border-color: #555; outline: none; }

    .frow textarea {
      border: 1px solid #aaa;
      padding: 6px;
      background: #fff;
      width: 100%;
      min-height: 230px;
      resize: vertical;
      font-family: 'Courier New', Courier, monospace;
      font-size: 12px;
      line-height: 1.55;
      tab-size: 2;
    }
    .frow textarea:focus { border-color: #555; outline: none; }

    .frow-2col { display: flex; gap: 10px; }
    .frow-2col .frow { flex: 1; }

    .hint { font-size: 11px; color: #999; margin-top: 3px; line-height: 1.5; }
    .hint code { font-family: 'Courier New', monospace; background: #f5f5f5; padding: 1px 3px; }

    .frow-check { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; font-size: 12px; }
    .frow-check input[type=checkbox] { margin: 0; cursor: pointer; }
    .frow-check label { cursor: pointer; }

    .rl-sub { display: flex; gap: 8px; margin-top: 6px; }
    .rl-sub input { flex: 1; width: auto; }
    .rl-sub select { flex: 2; width: auto; }
    .rl-sub input, .rl-sub select { border: 1px solid #aaa; padding: 4px 6px; }

    .sbtn {
      background: #efefef;
      border: 1px solid #aaa;
      padding: 4px 12px;
      cursor: pointer;
      font-size: 12px;
    }
    .sbtn:hover { background: #e0e0e0; }
    .sbtn-primary {
      background: #6e45a2;
      border: 1px solid #5a3688;
      color: #fff;
    }
    .sbtn-primary:hover { background: #5a3688; }
    .sbtn-danger {
      background: #fff;
      border: 1px solid #cc0000;
      color: #cc0000;
    }
    .sbtn-danger:hover { background: #fff0f0; }

    /* ── Logs table ─────────────────────────────────────────────────────── */
    .logs-modal { width: 820px; }

    table.ltbl { border-collapse: collapse; width: 100%; font-size: 12px; }
    table.ltbl th {
      background: #efefef;
      border: 1px solid #ccc;
      padding: 4px 6px;
      text-align: left;
      font-size: 11px;
      white-space: nowrap;
    }
    table.ltbl td { border: 1px solid #ddd; padding: 4px 6px; vertical-align: top; }
    table.ltbl tbody tr:hover td { background: #f5f0ff; }
    table.ltbl .exp-row:hover td { background: transparent; cursor: default; }

    .s-ok  { color: #006600; font-weight: bold; }
    .s-err { color: #cc0000; font-weight: bold; }

    .trunc {
      display: block;
      max-width: 180px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: #666;
      cursor: pointer;
    }
    .trunc:hover { color: #000; }

    .exp-box {
      background: #f8f8f8;
      border: 1px solid #ddd;
      padding: 6px 8px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 4px;
    }

    .logs-actions { margin-bottom: 10px; }

    /* ── Misc ───────────────────────────────────────────────────────────── */
    .hidden { display: none !important; }
    hr { border: none; border-top: 1px solid #ddd; margin: 10px 0; }
  </style>
</head>
<body>

<!-- ── Auth page ──────────────────────────────────────────────────────────── -->
<div id="auth-page">
  <div id="auth-box">

    <div id="screen-setup" style="display:none">
      <h2>welcome to bleh</h2>
      <p class="sub">first time here — set a password for your dashboard</p>
      <div class="arow">
        <label for="setup-pw">Password</label>
        <input type="password" id="setup-pw" placeholder="at least 4 characters"
               onkeydown="if(event.key==='Enter') doSetup()" />
      </div>
      <button class="abtn" onclick="doSetup()">set password</button>
      <div class="err" id="setup-err"></div>
    </div>

    <div id="screen-login" style="display:none">
      <h2>bleh</h2>
      <p class="sub">api spawner dashboard</p>
      <div class="arow">
        <label for="login-pw">Password</label>
        <input type="password" id="login-pw" placeholder=""
               onkeydown="if(event.key==='Enter') doLogin()" />
      </div>
      <button class="abtn" onclick="doLogin()">enter</button>
      <div class="err" id="login-err"></div>
      <p style="margin-top:12px;font-size:11px">
        <button class="lnk" onclick="showScreen('forgot')">forgot password?</button>
      </p>
    </div>

    <div id="screen-forgot" style="display:none">
      <h2>reset password</h2>
      <p class="sub">enter the PASSPHRASE from your server env</p>
      <div class="arow">
        <label for="forgot-pp">Passphrase</label>
        <input type="password" id="forgot-pp" placeholder="" />
      </div>
      <div class="arow">
        <label for="forgot-pw">New password</label>
        <input type="password" id="forgot-pw" placeholder=""
               onkeydown="if(event.key==='Enter') doForgot()" />
      </div>
      <button class="abtn" onclick="doForgot()">reset</button>
      <div class="err" id="forgot-err"></div>
      <p style="margin-top:12px;font-size:11px">
        <button class="lnk" onclick="showScreen('login')">&larr; back</button>
      </p>
    </div>

  </div>
</div>

<!-- ── Dashboard ──────────────────────────────────────────────────────────── -->
<div id="app" class="hidden">
  <div id="topbar">
    <span class="site-name">bleh</span>
    <span class="sep">|</span>
    <button class="tlink new" onclick="openRouteModal(null)">+ new route</button>
    <span class="sep">|</span>
    <button class="tlink" onclick="doLogout()">lock</button>
  </div>

  <div id="main">
    <div id="route-count"></div>

    <table class="rtbl" id="routes-table">
      <thead>
        <tr>
          <th>method</th>
          <th>path</th>
          <th>cors</th>
          <th>logging</th>
          <th>rate limit</th>
          <th>enabled</th>
          <th>actions</th>
        </tr>
      </thead>
      <tbody id="routes-body">
        <tr class="empty-row"><td colspan="7">no routes yet</td></tr>
      </tbody>
    </table>
  </div>
</div>

<!-- ── Route modal ────────────────────────────────────────────────────────── -->
<div class="modal-bg hidden" id="route-modal" onclick="bgClose(event,'route-modal')">
  <div class="modal">
    <div class="modal-head">
      <h3 id="modal-title">new route</h3>
      <button class="modal-x" onclick="closeRouteModal()">&#215;</button>
    </div>
    <div class="modal-body">

      <div class="frow-2col">
        <div class="frow" style="flex:2">
          <label for="r-path">Path</label>
          <input type="text" id="r-path" placeholder="/your-endpoint  or  /user/:id" />
        </div>
        <div class="frow" style="flex:1">
          <label for="r-method">Method</label>
          <select id="r-method">
            <option>GET</option>
            <option>POST</option>
            <option>PUT</option>
            <option>DELETE</option>
            <option>PATCH</option>
          </select>
        </div>
      </div>

      <div class="frow">
        <label for="r-code">Handler code</label>
        <textarea id="r-code"
          placeholder="// available: req, body, headers, query, params&#10;&#10;const data = await fetch('https://api.example.com/').then(r => r.json())&#10;return { data }"></textarea>
        <div class="hint">
          <code>req</code> &nbsp;<code>body</code> &nbsp;<code>headers</code> &nbsp;<code>query</code> &nbsp;<code>params</code>
          &mdash; return any value or a <code>new Response(...)</code>
        </div>
      </div>

      <hr>

      <div class="frow-2col">
        <div class="frow">
          <label for="r-cors-type">CORS</label>
          <select id="r-cors-type" onchange="onCorsChange()">
            <option value="">disabled</option>
            <option value="*">allow all  (*)</option>
            <option value="custom">specific origin</option>
          </select>
        </div>
        <div class="frow" id="cors-custom-wrap" style="display:none">
          <label for="r-cors-custom">Origin URL</label>
          <input type="text" id="r-cors-custom" placeholder="https://myapp.com" />
        </div>
      </div>

      <div class="frow-check">
        <input type="checkbox" id="r-logging">
        <label for="r-logging">Log requests to SQLite</label>
      </div>

      <div class="frow-check">
        <input type="checkbox" id="r-rl" onchange="onRlChange()">
        <label for="r-rl">Rate limiting</label>
      </div>
      <div id="rl-wrap" style="display:none; margin-bottom:10px; margin-left:18px">
        <div class="rl-sub">
          <input type="number" id="r-rl-req" placeholder="100" min="1" style="width:80px" />
          <select id="r-rl-win">
            <option value="10s">per 10 seconds</option>
            <option value="1m" selected>per minute</option>
            <option value="5m">per 5 minutes</option>
            <option value="15m">per 15 minutes</option>
            <option value="1h">per hour</option>
            <option value="1d">per day</option>
          </select>
        </div>
      </div>

    </div>
    <div class="modal-foot">
      <div>
        <button class="sbtn sbtn-danger hidden" id="modal-del" onclick="deleteRoute()">delete route</button>
      </div>
      <div class="foot-right">
        <button class="sbtn" onclick="closeRouteModal()">cancel</button>
        <button class="sbtn sbtn-primary" onclick="saveRoute()">save</button>
      </div>
    </div>
  </div>
</div>

<!-- ── Logs modal ─────────────────────────────────────────────────────────── -->
<div class="modal-bg hidden" id="logs-modal" onclick="bgClose(event,'logs-modal')">
  <div class="modal logs-modal">
    <div class="modal-head">
      <h3 id="logs-title">logs</h3>
      <button class="modal-x" onclick="closeLogsModal()">&#215;</button>
    </div>
    <div class="modal-body">
      <div class="logs-actions">
        <button class="sbtn sbtn-danger" onclick="doClearLogs()">clear logs</button>
      </div>
      <table class="ltbl">
        <thead>
          <tr>
            <th>time</th>
            <th>status</th>
            <th>method</th>
            <th>request body</th>
            <th>response</th>
          </tr>
        </thead>
        <tbody id="logs-body"></tbody>
      </table>
      <div id="logs-empty" class="hidden" style="color:#888;font-style:italic;padding:16px 0">
        no logs yet for this route
      </div>
    </div>
  </div>
</div>

<script>
  let pwd = null;
  let routes = [];
  let editingId = null;
  let logsRouteId = null;

  // ── API ─────────────────────────────────────────────────────────────────────
  async function api(path, method, body) {
    var res = await fetch('/__dashboard' + path, {
      method: method || 'GET',
      headers: Object.assign(
        { 'Content-Type': 'application/json' },
        pwd ? { 'X-Password': pwd } : {}
      ),
      body: body !== undefined ? JSON.stringify(body) : undefined
    });
    return res.json();
  }

  // ── Auth ────────────────────────────────────────────────────────────────────
  function showScreen(name) {
    ['setup', 'login', 'forgot'].forEach(function(s) {
      document.getElementById('screen-' + s).style.display = s === name ? '' : 'none';
    });
    setTimeout(function() {
      var map = { setup: 'setup-pw', login: 'login-pw', forgot: 'forgot-pp' };
      var el = document.getElementById(map[name]);
      if (el) el.focus();
    }, 40);
  }

  function setErr(id, msg) { document.getElementById(id).textContent = msg || ''; }

  async function init() {
    var res = await api('/status');
    showScreen(res.setup ? 'login' : 'setup');
  }

  async function doSetup() {
    setErr('setup-err', '');
    var pw = document.getElementById('setup-pw').value;
    var res = await api('/setup', 'POST', { password: pw });
    if (res.error) return setErr('setup-err', res.error);
    pwd = pw;
    enterDashboard();
  }

  async function doLogin() {
    setErr('login-err', '');
    var pw = document.getElementById('login-pw').value;
    var res = await api('/login', 'POST', { password: pw });
    if (!res.ok) return setErr('login-err', 'wrong password');
    pwd = pw;
    enterDashboard();
  }

  async function doForgot() {
    setErr('forgot-err', '');
    var pp = document.getElementById('forgot-pp').value;
    var pw = document.getElementById('forgot-pw').value;
    var res = await api('/forgot', 'POST', { passphrase: pp, password: pw });
    if (res.error) return setErr('forgot-err', res.error);
    pwd = pw;
    enterDashboard();
  }

  function doLogout() {
    pwd = null;
    document.getElementById('app').classList.add('hidden');
    document.getElementById('auth-page').classList.remove('hidden');
    document.getElementById('login-pw').value = '';
    showScreen('login');
  }

  async function enterDashboard() {
    document.getElementById('auth-page').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    await loadRoutes();
  }

  // ── Routes ──────────────────────────────────────────────────────────────────
  async function loadRoutes() {
    routes = await api('/routes');
    renderRoutes();
  }

  function renderRoutes() {
    var tbody  = document.getElementById('routes-body');
    var cnt    = document.getElementById('route-count');

    cnt.textContent = routes.length
      ? routes.length + ' route' + (routes.length !== 1 ? 's' : '')
      : '';

    if (!routes.length) {
      tbody.innerHTML = '<tr class="empty-row"><td colspan="7">no routes yet &mdash; <button class="lnk" onclick="openRouteModal(null)">create one</button></td></tr>';
      return;
    }

    tbody.innerHTML = routes.map(function(r) {
      var corsLabel = !r.corsOrigin ? '&mdash;'
        : r.corsOrigin === '*' ? 'all (*)'
        : esc(r.corsOrigin);
      var rlLabel = (r.rateLimit && r.rateLimit.enabled)
        ? r.rateLimit.requests + ' / ' + r.rateLimit.window
        : '&mdash;';

      return '<tr>'
        + '<td><span class="m-' + r.method + '">' + r.method + '</span></td>'
        + '<td><code style="font-size:12px">' + esc(r.path) + '</code></td>'
        + '<td style="font-size:11px;color:#666">' + corsLabel + '</td>'
        + '<td style="text-align:center"><input type="checkbox"' + (r.logging ? ' checked' : '')
        +   ' onchange="patchRoute(\'' + r.id + '\',{logging:this.checked})"></td>'
        + '<td style="font-size:11px;color:#666">' + rlLabel + '</td>'
        + '<td style="text-align:center"><input type="checkbox"' + (r.enabled ? ' checked' : '')
        +   ' onchange="patchRoute(\'' + r.id + '\',{enabled:this.checked})"></td>'
        + '<td style="white-space:nowrap;font-size:12px">'
        +   '<button class="lnk" onclick="openRouteModal(\'' + r.id + '\')">edit</button>'
        +   ' &nbsp;'
        +   '<button class="lnk" onclick="openLogsModal(\'' + r.id + '\',\'' + esc(r.path) + '\')">logs</button>'
        + '</td>'
        + '</tr>';
    }).join('');
  }

  async function patchRoute(id, updates) {
    await api('/routes/' + id, 'PATCH', updates);
    var r = routes.find(function(x) { return x.id === id; });
    if (r) Object.assign(r, updates);
  }

  // ── Route modal ─────────────────────────────────────────────────────────────
  function openRouteModal(id) {
    editingId = id || null;
    var delBtn = document.getElementById('modal-del');

    if (id) {
      document.getElementById('modal-title').textContent = 'edit route';
      delBtn.classList.remove('hidden');
      var r = routes.find(function(x) { return x.id === id; });
      if (!r) return;

      document.getElementById('r-path').value   = r.path;
      document.getElementById('r-method').value = r.method;
      document.getElementById('r-code').value   = r.code;
      document.getElementById('r-logging').checked = r.logging;

      var ct = !r.corsOrigin ? '' : r.corsOrigin === '*' ? '*' : 'custom';
      document.getElementById('r-cors-type').value = ct;
      document.getElementById('cors-custom-wrap').style.display = ct === 'custom' ? '' : 'none';
      document.getElementById('r-cors-custom').value = ct === 'custom' ? r.corsOrigin : '';

      var rl = r.rateLimit && r.rateLimit.enabled;
      document.getElementById('r-rl').checked = !!rl;
      document.getElementById('rl-wrap').style.display = rl ? '' : 'none';
      if (rl) {
        document.getElementById('r-rl-req').value = r.rateLimit.requests;
        document.getElementById('r-rl-win').value = r.rateLimit.window;
      }
    } else {
      document.getElementById('modal-title').textContent = 'new route';
      delBtn.classList.add('hidden');
      document.getElementById('r-path').value   = '';
      document.getElementById('r-method').value = 'GET';
      document.getElementById('r-code').value   = '';
      document.getElementById('r-logging').checked = false;
      document.getElementById('r-cors-type').value = '';
      document.getElementById('cors-custom-wrap').style.display = 'none';
      document.getElementById('r-cors-custom').value = '';
      document.getElementById('r-rl').checked = false;
      document.getElementById('rl-wrap').style.display = 'none';
      document.getElementById('r-rl-req').value = '100';
      document.getElementById('r-rl-win').value = '1m';
    }

    document.getElementById('route-modal').classList.remove('hidden');
    setTimeout(function() { document.getElementById('r-path').focus(); }, 40);
  }

  function closeRouteModal() {
    document.getElementById('route-modal').classList.add('hidden');
    editingId = null;
  }

  function onCorsChange() {
    var v = document.getElementById('r-cors-type').value;
    document.getElementById('cors-custom-wrap').style.display = v === 'custom' ? '' : 'none';
  }

  function onRlChange() {
    document.getElementById('rl-wrap').style.display =
      document.getElementById('r-rl').checked ? '' : 'none';
  }

  async function saveRoute() {
    var path = document.getElementById('r-path').value.trim();
    if (!path.startsWith('/')) {
      alert('Path must start with /');
      document.getElementById('r-path').focus();
      return;
    }

    var ct = document.getElementById('r-cors-type').value;
    var corsOrigin = ct === 'custom'
      ? document.getElementById('r-cors-custom').value.trim()
      : ct;

    var rlOn = document.getElementById('r-rl').checked;
    var rateLimit = rlOn ? {
      enabled:  true,
      requests: parseInt(document.getElementById('r-rl-req').value) || 100,
      window:   document.getElementById('r-rl-win').value
    } : null;

    var data = {
      path:       path,
      method:     document.getElementById('r-method').value,
      code:       document.getElementById('r-code').value,
      corsOrigin: corsOrigin,
      logging:    document.getElementById('r-logging').checked,
      rateLimit:  rateLimit
    };

    if (editingId) {
      await api('/routes/' + editingId, 'PUT', data);
    } else {
      await api('/routes', 'POST', data);
    }

    closeRouteModal();
    await loadRoutes();
  }

  async function deleteRoute() {
    if (!editingId || !confirm('Delete this route and all its logs?')) return;
    await api('/routes/' + editingId, 'DELETE');
    closeRouteModal();
    await loadRoutes();
  }

  // ── Logs modal ──────────────────────────────────────────────────────────────
  async function openLogsModal(id, path) {
    logsRouteId = id;
    document.getElementById('logs-title').textContent = 'logs: ' + path;
    document.getElementById('logs-modal').classList.remove('hidden');
    await loadLogs();
  }

  function closeLogsModal() {
    document.getElementById('logs-modal').classList.add('hidden');
    logsRouteId = null;
  }

  async function loadLogs() {
    if (!logsRouteId) return;
    var logs = await api('/routes/' + logsRouteId + '/logs');
    var tbody = document.getElementById('logs-body');
    var empty = document.getElementById('logs-empty');

    if (!logs.length) {
      tbody.innerHTML = '';
      empty.classList.remove('hidden');
      return;
    }
    empty.classList.add('hidden');

    tbody.innerHTML = logs.map(function(l, i) {
      var ts = new Date(l.timestamp + 'Z').toLocaleString();
      var cls = l.status < 400 ? 's-ok' : 's-err';
      return '<tr style="cursor:pointer" onclick="toggleExpand(' + i + ')">'
        + '<td style="white-space:nowrap;font-size:11px;color:#666">' + esc(ts) + '</td>'
        + '<td class="' + cls + '">' + l.status + '</td>'
        + '<td><span class="m-' + l.method + '">' + l.method + '</span></td>'
        + '<td><span class="trunc">' + esc(l.request_body || '—') + '</span></td>'
        + '<td><span class="trunc">' + esc(l.response_body || '—') + '</span></td>'
        + '</tr>'
        + '<tr class="exp-row hidden" id="exp-' + i + '">'
        + '<td colspan="5">'
        + '<div style="display:flex;gap:10px;padding:4px 0 6px">'
        + '<div style="flex:1"><strong style="font-size:11px">request body</strong><div class="exp-box">' + esc(pretty(l.request_body)) + '</div></div>'
        + '<div style="flex:1"><strong style="font-size:11px">response</strong><div class="exp-box">' + esc(pretty(l.response_body)) + '</div></div>'
        + '</div></td></tr>';
    }).join('');
  }

  function toggleExpand(i) {
    var row = document.getElementById('exp-' + i);
    if (row) row.classList.toggle('hidden');
  }

  async function doClearLogs() {
    if (!logsRouteId || !confirm('Clear all logs for this route?')) return;
    await api('/routes/' + logsRouteId + '/logs', 'DELETE');
    await loadLogs();
  }

  // ── Utils ───────────────────────────────────────────────────────────────────
  function bgClose(e, id) {
    if (e.target.id === id) {
      if (id === 'route-modal') closeRouteModal();
      else closeLogsModal();
    }
  }

  function esc(s) {
    return String(s || '')
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function pretty(s) {
    if (!s) return '';
    try { return JSON.stringify(JSON.parse(s), null, 2); }
    catch { return s; }
  }

  // Tab in textarea
  document.addEventListener('DOMContentLoaded', function() {
    var ta = document.getElementById('r-code');
    ta.addEventListener('keydown', function(e) {
      if (e.key === 'Tab') {
        e.preventDefault();
        var s = ta.selectionStart;
        ta.value = ta.value.slice(0, s) + '  ' + ta.value.slice(ta.selectionEnd);
        ta.selectionStart = ta.selectionEnd = s + 2;
      }
    });
    init();
  });
</script>
</body>
</html>
