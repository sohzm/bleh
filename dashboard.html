<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>bleh</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --black: #000;
      --white: #fff;
      --gray-50: #f7f7f7;
      --gray-100: #ebebeb;
      --gray-200: #d8d8d8;
      --gray-400: #9e9e9e;
      --gray-600: #545454;
      --gray-800: #1a1a1a;
      --green: #00a35f;
      --red: #c0392b;
      --font: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      --mono: 'SF Mono', 'Fira Code', Consolas, monospace;
    }

    body {
      font-family: var(--font);
      font-size: 14px;
      background: var(--white);
      color: var(--black);
      line-height: 1.5;
    }

    /* ── Topbar ── */
    #topbar {
      background: var(--black);
      color: var(--white);
      height: 52px;
      display: flex;
      align-items: center;
      padding: 0 28px;
      gap: 0;
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .topbar-logo {
      font-weight: 700;
      font-size: 15px;
      letter-spacing: -0.3px;
      margin-right: 28px;
    }

    .topbar-nav {
      display: flex;
      gap: 2px;
      flex: 1;
    }

    .nav-btn {
      background: none;
      border: none;
      color: rgba(255,255,255,0.45);
      font-size: 13px;
      font-family: var(--font);
      font-weight: 500;
      padding: 6px 14px;
      cursor: pointer;
      border-radius: 4px;
      transition: color 0.1s, background 0.1s;
    }
    .nav-btn:hover { color: rgba(255,255,255,0.8); background: rgba(255,255,255,0.07); }
    .nav-btn.active { color: var(--white); background: rgba(255,255,255,0.12); }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .server-badge {
      font-family: var(--mono);
      font-size: 11px;
      color: rgba(255,255,255,0.35);
    }

    .topbar-link-btn {
      background: none;
      border: 1px solid rgba(255,255,255,0.18);
      color: rgba(255,255,255,0.55);
      font-size: 12px;
      font-family: var(--font);
      padding: 4px 12px;
      cursor: pointer;
      border-radius: 3px;
      transition: color 0.1s, border-color 0.1s;
    }
    .topbar-link-btn:hover { color: var(--white); border-color: rgba(255,255,255,0.4); }

    /* ── Layout ── */
    #app { display: none; }

    .section {
      display: none;
      padding: 36px 28px;
      max-width: 1040px;
      margin: 0 auto;
    }
    .section.active { display: block; }

    /* ── Section header ── */
    .section-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      margin-bottom: 28px;
    }

    .section-title {
      font-size: 22px;
      font-weight: 600;
      letter-spacing: -0.4px;
    }

    .section-count {
      font-size: 13px;
      color: var(--gray-400);
      margin-left: 8px;
      font-weight: 400;
    }

    /* ── Buttons ── */
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 16px;
      font-size: 13px;
      font-family: var(--font);
      font-weight: 500;
      border: none;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.1s, opacity 0.1s;
      text-decoration: none;
    }

    .btn-primary { background: var(--black); color: var(--white); }
    .btn-primary:hover { background: var(--gray-800); }

    .btn-outline {
      background: transparent;
      color: var(--black);
      border: 1px solid var(--gray-200);
    }
    .btn-outline:hover { background: var(--gray-50); }

    .btn-ghost {
      background: none;
      border: none;
      color: var(--gray-600);
      font-size: 12px;
      font-family: var(--font);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 3px;
    }
    .btn-ghost:hover { background: var(--gray-100); color: var(--black); }

    .btn-ghost-danger {
      background: none;
      border: none;
      color: var(--red);
      font-size: 12px;
      font-family: var(--font);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 3px;
    }
    .btn-ghost-danger:hover { background: #fff0f0; }

    .btn-sm { padding: 5px 12px; font-size: 12px; }

    /* ── Table ── */
    .table-wrap {
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      overflow: hidden;
    }

    table { width: 100%; border-collapse: collapse; }

    th {
      text-align: left;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--gray-400);
      padding: 10px 16px;
      border-bottom: 1px solid var(--gray-200);
      background: var(--gray-50);
    }

    td {
      padding: 13px 16px;
      border-bottom: 1px solid var(--gray-100);
      vertical-align: middle;
      font-size: 13px;
    }

    tr:last-child td { border-bottom: none; }
    tbody tr:hover td { background: var(--gray-50); }

    .empty-state {
      padding: 52px 16px;
      text-align: center;
      color: var(--gray-400);
      font-size: 13px;
    }

    /* ── Method badge ── */
    .method {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 700;
      padding: 2px 7px;
      border-radius: 3px;
      letter-spacing: 0.02em;
    }
    .method-GET    { color: #166534; background: #dcfce7; }
    .method-POST   { color: #1e40af; background: #dbeafe; }
    .method-PUT    { color: #92400e; background: #fef3c7; }
    .method-DELETE { color: #991b1b; background: #fee2e2; }
    .method-PATCH  { color: #5b21b6; background: #ede9fe; }

    /* ── Toggle ── */
    .toggle { position: relative; display: inline-block; width: 32px; height: 18px; }
    .toggle input { opacity: 0; width: 0; height: 0; }
    .toggle-track {
      position: absolute; inset: 0;
      background: var(--gray-200);
      border-radius: 9px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .toggle-track::after {
      content: '';
      position: absolute;
      width: 12px; height: 12px;
      left: 3px; top: 3px;
      background: white;
      border-radius: 50%;
      transition: transform 0.15s;
    }
    .toggle input:checked + .toggle-track { background: var(--black); }
    .toggle input:checked + .toggle-track::after { transform: translateX(14px); }

    /* ── Code editor ── */
    .code-editor {
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.65;
      background: #0d0d0d;
      color: #e8e8e8;
      border: 1px solid #2a2a2a;
      border-radius: 4px;
      padding: 14px;
      width: 100%;
      resize: vertical;
      min-height: 190px;
      tab-size: 2;
      outline: none;
    }
    .code-editor:focus { border-color: #444; }

    /* ── Form ── */
    .form-row { margin-bottom: 16px; }
    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--gray-600);
      margin-bottom: 6px;
    }

    input[type="text"], input[type="password"], input[type="number"], select, textarea {
      width: 100%;
      padding: 8px 11px;
      font-size: 13px;
      font-family: var(--font);
      border: 1px solid var(--gray-200);
      border-radius: 4px;
      outline: none;
      background: var(--white);
      color: var(--black);
      transition: border-color 0.1s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--black); }

    .form-inline { display: flex; gap: 12px; }
    .form-check { display: flex; align-items: center; gap: 8px; font-size: 13px; cursor: pointer; }
    .hint { font-size: 11px; color: var(--gray-400); margin-top: 4px; }

    /* ── Modal ── */
    .modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1000;
      align-items: flex-start;
      justify-content: center;
      padding: 60px 16px;
      overflow-y: auto;
    }
    .modal-overlay.open { display: flex; }

    .modal {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      width: 100%;
      max-width: 640px;
      margin-bottom: 60px;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--gray-100);
    }
    .modal-title { font-size: 15px; font-weight: 600; }

    .modal-x {
      background: none; border: none; cursor: pointer;
      color: var(--gray-400); font-size: 22px; line-height: 1; padding: 0;
    }
    .modal-x:hover { color: var(--black); }

    .modal-body { padding: 24px; }

    .modal-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-top: 1px solid var(--gray-100);
    }
    .modal-footer-right { display: flex; gap: 8px; }

    /* ── Auth ── */
    #auth-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--gray-50);
    }

    #auth-box {
      width: 360px;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      padding: 36px 32px;
    }

    .auth-logo {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.4px;
      margin-bottom: 6px;
    }

    .auth-sub {
      font-size: 13px;
      color: var(--gray-400);
      margin-bottom: 28px;
      line-height: 1.5;
    }

    .auth-err {
      color: var(--red);
      font-size: 12px;
      margin-top: 10px;
      min-height: 18px;
    }

    .auth-link {
      background: none; border: none; font-family: var(--font);
      font-size: 12px; color: var(--gray-600); cursor: pointer;
      text-decoration: underline; text-underline-offset: 2px;
    }
    .auth-link:hover { color: var(--black); }

    /* ── Logs ── */
    #log-list { max-height: 420px; overflow-y: auto; }

    .log-entry {
      padding: 10px 0;
      border-bottom: 1px solid var(--gray-100);
    }
    .log-entry:last-child { border-bottom: none; }

    .log-meta {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--gray-400);
      margin-bottom: 4px;
    }

    .log-ok  { color: var(--green); }
    .log-err { color: var(--red); }

    .log-body {
      font-family: var(--mono);
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-all;
      background: var(--gray-50);
      border: 1px solid var(--gray-100);
      border-radius: 3px;
      padding: 6px 8px;
      max-height: 100px;
      overflow-y: auto;
      margin-top: 4px;
    }

    /* ── Store ── */
    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      color: var(--gray-400);
      margin-bottom: 20px;
    }
    .breadcrumb .crumb { cursor: pointer; color: var(--black); }
    .breadcrumb .crumb:hover { text-decoration: underline; }

    /* ── Files ── */
    .file-url {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--gray-600);
    }

    .upload-zone {
      border: 2px dashed var(--gray-200);
      border-radius: 6px;
      padding: 48px 24px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.1s, background 0.1s;
    }
    .upload-zone:hover, .upload-zone.drag-over {
      border-color: var(--black);
      background: var(--gray-50);
    }
    .uz-title { font-weight: 500; font-size: 14px; margin-bottom: 4px; }
    .uz-sub { font-size: 12px; color: var(--gray-400); }
    #file-input { display: none; }
    .upload-status { font-size: 12px; color: var(--gray-600); margin-top: 12px; text-align: center; }

    /* ── Docs ── */
    .doc-section { margin-bottom: 24px; }
    .doc-section h3 {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--gray-600);
      margin-bottom: 10px;
    }
    .doc-section p { font-size: 13px; color: var(--gray-800); line-height: 1.6; margin-bottom: 8px; }
    .doc-section code {
      font-family: var(--mono);
      font-size: 12px;
      background: var(--gray-100);
      border-radius: 3px;
      padding: 1px 5px;
    }
    .doc-section pre {
      font-family: var(--mono);
      font-size: 12px;
      line-height: 1.65;
      background: #0d0d0d;
      color: #e8e8e8;
      padding: 14px;
      border-radius: 4px;
      overflow-x: auto;
    }

    /* ── Toast ── */
    #toast {
      position: fixed;
      bottom: 28px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--black);
      color: var(--white);
      font-size: 13px;
      padding: 10px 20px;
      border-radius: 6px;
      opacity: 0;
      pointer-events: none;
      z-index: 9999;
      transition: opacity 0.15s;
      white-space: nowrap;
    }
    #toast.show { opacity: 1; }

    /* ── Misc ── */
    .mono { font-family: var(--mono); }
    .muted { color: var(--gray-400); }
    .sm { font-size: 12px; }
    .actions { display: flex; align-items: center; gap: 4px; }
  </style>
</head>
<body>

<!-- Auth -->
<div id="auth-page">
  <div id="auth-box">
    <div class="auth-logo">bleh</div>

    <div id="auth-setup" style="display:none">
      <div class="auth-sub">Create a password to protect this dashboard.</div>
      <div class="form-row">
        <label class="form-label">Password</label>
        <input type="password" id="setup-pw" placeholder="Choose a password" autocomplete="new-password"
               onkeydown="if(event.key==='Enter')doSetup()">
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="doSetup()">Create Password</button>
      <div class="auth-err" id="setup-err"></div>
    </div>

    <div id="auth-login" style="display:none">
      <div class="auth-sub">Enter your dashboard password to continue.</div>
      <div class="form-row">
        <label class="form-label">Password</label>
        <input type="password" id="login-pw" placeholder="Password" autocomplete="current-password"
               onkeydown="if(event.key==='Enter')doLogin()">
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="doLogin()">Sign In</button>
      <div class="auth-err" id="login-err"></div>
      <div style="margin-top:16px">
        <button class="auth-link" onclick="showForgot()">Forgot password?</button>
      </div>
    </div>

    <div id="auth-forgot" style="display:none">
      <div class="auth-sub">Reset your password using the <code style="font-family:var(--mono);font-size:12px;background:var(--gray-100);padding:1px 4px;border-radius:3px">PASSPHRASE</code> env variable.</div>
      <div class="form-row">
        <label class="form-label">Passphrase</label>
        <input type="password" id="forgot-phrase" placeholder="PASSPHRASE value">
      </div>
      <div class="form-row">
        <label class="form-label">New Password</label>
        <input type="password" id="forgot-pw" placeholder="New password" onkeydown="if(event.key==='Enter')doForgot()">
      </div>
      <button class="btn btn-primary" style="width:100%" onclick="doForgot()">Reset Password</button>
      <div class="auth-err" id="forgot-err"></div>
      <div style="margin-top:16px">
        <button class="auth-link" onclick="showLogin()">Back to sign in</button>
      </div>
    </div>
  </div>
</div>

<!-- App -->
<div id="app">
  <div id="topbar">
    <div class="topbar-logo">bleh</div>
    <div class="topbar-nav">
      <button class="nav-btn active" id="tab-routes"  onclick="showTab('routes')">Routes</button>
      <button class="nav-btn"        id="tab-crons"   onclick="showTab('crons')">Crons</button>
      <button class="nav-btn"        id="tab-files"   onclick="showTab('files')">Files</button>
      <button class="nav-btn"        id="tab-store"   onclick="showTab('store')">Store</button>
    </div>
    <div class="topbar-right">
      <span class="server-badge" id="server-badge"></span>
      <button class="topbar-link-btn" onclick="openModal('docs-modal')">Docs</button>
      <button class="topbar-link-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Routes -->
  <div class="section active" id="section-routes">
    <div class="section-header">
      <div>
        <span class="section-title">Routes</span>
        <span class="section-count" id="routes-count"></span>
      </div>
      <button class="btn btn-primary" onclick="openRouteModal()">+ New Route</button>
    </div>
    <div id="routes-wrap"></div>
  </div>

  <!-- Crons -->
  <div class="section" id="section-crons">
    <div class="section-header">
      <div>
        <span class="section-title">Crons</span>
        <span class="section-count" id="crons-count"></span>
      </div>
      <button class="btn btn-primary" onclick="openCronModal()">+ New Cron</button>
    </div>
    <div id="crons-wrap"></div>
  </div>

  <!-- Files -->
  <div class="section" id="section-files">
    <div class="section-header">
      <div>
        <span class="section-title">Files</span>
        <span class="section-count" id="files-count"></span>
      </div>
      <button class="btn btn-primary" onclick="openModal('upload-modal')">+ Upload</button>
    </div>
    <div id="files-wrap"></div>
  </div>

  <!-- Store -->
  <div class="section" id="section-store">
    <div class="section-header">
      <span class="section-title">Store</span>
    </div>
    <div id="store-wrap"></div>
  </div>
</div>

<!-- Route Modal -->
<div class="modal-overlay" id="route-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="route-modal-title">New Route</div>
      <button class="modal-x" onclick="closeModal('route-modal')">×</button>
    </div>
    <div class="modal-body">
      <div class="form-inline" style="margin-bottom:16px">
        <div style="flex:0 0 110px">
          <label class="form-label">Method</label>
          <select id="r-method">
            <option>GET</option><option>POST</option><option>PUT</option>
            <option>PATCH</option><option>DELETE</option>
          </select>
        </div>
        <div style="flex:1">
          <label class="form-label">Path</label>
          <input type="text" id="r-path" placeholder="/api/hello">
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Handler Code</label>
        <textarea class="code-editor" id="r-code" rows="10"
          placeholder="return { hello: 'world' };&#10;// Variables: req, body, headers, query, params, store"></textarea>
      </div>
      <div class="form-inline" style="margin-bottom:16px">
        <div style="flex:1">
          <label class="form-label">CORS Origin</label>
          <select id="r-cors" onchange="toggleCorsCustom()">
            <option value="">Off</option>
            <option value="*">All (*)</option>
            <option value="custom">Custom…</option>
          </select>
        </div>
        <div style="flex:1" id="r-cors-custom-row" style="display:none">
          <label class="form-label">Origin URL</label>
          <input type="text" id="r-cors-custom" placeholder="https://example.com">
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Rate Limiting</label>
        <label class="form-check" style="margin-bottom:8px">
          <input type="checkbox" id="r-rl-enabled" onchange="toggleRateLimit()">
          <span>Enable rate limiting</span>
        </label>
        <div id="r-rl-fields" style="display:none">
          <div class="form-inline">
            <div>
              <label class="form-label">Requests</label>
              <input type="number" id="r-rl-req" value="100" min="1">
            </div>
            <div>
              <label class="form-label">Window</label>
              <input type="text" id="r-rl-win" value="1m">
              <div class="hint">30s · 1m · 1h · 1d</div>
            </div>
            <div style="display:flex;align-items:flex-end;padding-bottom:6px">
              <label class="form-check">
                <input type="checkbox" id="r-rl-perip">
                <span>Per IP</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      <div style="display:flex;gap:24px">
        <label class="form-check">
          <input type="checkbox" id="r-logging">
          <span>Log requests</span>
        </label>
        <label class="form-check">
          <input type="checkbox" id="r-enabled" checked>
          <span>Enabled</span>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <div>
        <button class="btn-ghost-danger" id="r-delete-btn" onclick="deleteRoute()" style="display:none">Delete route</button>
      </div>
      <div class="modal-footer-right">
        <button class="btn btn-outline" onclick="closeModal('route-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveRoute()">Save Route</button>
      </div>
    </div>
  </div>
</div>

<!-- Cron Modal -->
<div class="modal-overlay" id="cron-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title" id="cron-modal-title">New Cron Job</div>
      <button class="modal-x" onclick="closeModal('cron-modal')">×</button>
    </div>
    <div class="modal-body">
      <div class="form-inline" style="margin-bottom:16px">
        <div style="flex:1">
          <label class="form-label">Name</label>
          <input type="text" id="c-name" placeholder="sync-data">
        </div>
        <div style="flex:0 0 130px">
          <label class="form-label">Schedule</label>
          <input type="text" id="c-schedule" placeholder="5m">
          <div class="hint">30s · 5m · 1h · 1d</div>
        </div>
      </div>
      <div class="form-row">
        <label class="form-label">Handler Code</label>
        <textarea class="code-editor" id="c-code" rows="10"
          placeholder="// Variables: store&#10;const data = await fetch('https://...').then(r => r.json());&#10;store.set('cache', 'result', data);"></textarea>
      </div>
      <div style="display:flex;gap:24px">
        <label class="form-check">
          <input type="checkbox" id="c-logging">
          <span>Log runs</span>
        </label>
        <label class="form-check">
          <input type="checkbox" id="c-enabled" checked>
          <span>Enabled</span>
        </label>
      </div>
    </div>
    <div class="modal-footer">
      <div>
        <button class="btn-ghost-danger" id="c-delete-btn" onclick="deleteCron()" style="display:none">Delete job</button>
      </div>
      <div class="modal-footer-right">
        <button class="btn btn-outline" onclick="closeModal('cron-modal')">Cancel</button>
        <button class="btn btn-primary" onclick="saveCron()">Save Job</button>
      </div>
    </div>
  </div>
</div>

<!-- Logs Modal -->
<div class="modal-overlay" id="logs-modal">
  <div class="modal" style="max-width:720px">
    <div class="modal-header">
      <div class="modal-title" id="logs-title">Logs</div>
      <button class="modal-x" onclick="closeModal('logs-modal')">×</button>
    </div>
    <div class="modal-body">
      <div style="display:flex;justify-content:flex-end;margin-bottom:12px">
        <button class="btn btn-outline btn-sm" onclick="clearLogs()">Clear logs</button>
      </div>
      <div id="log-list"><div class="empty-state">No logs.</div></div>
    </div>
  </div>
</div>

<!-- Upload Modal -->
<div class="modal-overlay" id="upload-modal">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-title">Upload File</div>
      <button class="modal-x" onclick="closeModal('upload-modal')">×</button>
    </div>
    <div class="modal-body">
      <div class="upload-zone" id="upload-zone"
           onclick="document.getElementById('file-input').click()"
           ondragover="event.preventDefault();this.classList.add('drag-over')"
           ondragleave="this.classList.remove('drag-over')"
           ondrop="handleDrop(event)">
        <div class="uz-title">Drop a file or click to browse</div>
        <div class="uz-sub">Any file type · Served at /__u/ID</div>
      </div>
      <input type="file" id="file-input" onchange="handleFileSelect(this.files[0])">
      <div class="upload-status" id="upload-status" style="display:none"></div>
    </div>
    <div class="modal-footer" style="justify-content:flex-end">
      <button class="btn btn-outline" onclick="closeModal('upload-modal')">Close</button>
    </div>
  </div>
</div>

<!-- Docs Modal -->
<div class="modal-overlay" id="docs-modal">
  <div class="modal" style="max-width:680px">
    <div class="modal-header">
      <div class="modal-title">Documentation</div>
      <button class="modal-x" onclick="closeModal('docs-modal')">×</button>
    </div>
    <div class="modal-body" style="max-height:72vh;overflow-y:auto">
      <div class="doc-section">
        <h3>Route Handler</h3>
        <p>Available variables: <code>req</code>, <code>body</code>, <code>headers</code>, <code>query</code>, <code>params</code>, <code>store</code></p>
        <pre>return { hello: req.method };

// Custom response
return new Response('pong', { status: 200 });

// Path params (/user/:id)
return { id: params.id };

// Fetch external data
const data = await fetch('https://api.example.com/').then(r => r.json());
return data;</pre>
      </div>
      <div class="doc-section">
        <h3>Cron Handler</h3>
        <p>Runs on schedule. Available variables: <code>store</code></p>
        <pre>const data = await fetch('https://...').then(r => r.json());
store.set('cache', 'items', data);</pre>
      </div>
      <div class="doc-section">
        <h3>Store API</h3>
        <pre>store.set('col', 'key', value)    // upsert
store.get('col', 'key')           // → value | null
store.all('col')                  // → [{key, value, updatedAt}]
store.delete('col', 'key')        // delete entry
store.drop('col')                 // delete collection
store.find('col', v => v.active)  // filter by value</pre>
      </div>
      <div class="doc-section">
        <h3>Rate Limiting</h3>
        <p>Set max requests per time window globally or per IP. Window format: <code>30s</code> <code>1m</code> <code>1h</code> <code>1d</code></p>
      </div>
      <div class="doc-section">
        <h3>File Hosting</h3>
        <p>Upload files in the Files tab. Each file is served at <code>/__u/FILE_ID</code> with the correct Content-Type.</p>
      </div>
    </div>
    <div class="modal-footer" style="justify-content:flex-end;gap:8px">
      <a href="https://github.com/sohzm/bleh" target="_blank" class="btn btn-outline btn-sm">GitHub</a>
      <button class="btn btn-primary" onclick="closeModal('docs-modal')">Close</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"></div>

<script>
let pwd = '';
let routes = [], crons = [], files = [];
let editingRouteId = null, editingCronId = null;
let currentLogsApi = '';

// ── Helpers ───────────────────────────────────────────────────────────────────
async function api(path, method = 'GET', body = null) {
  const opts = { method, headers: { 'X-Password': pwd } };
  if (body !== null && !(body instanceof FormData)) {
    opts.headers['Content-Type'] = 'application/json';
    opts.body = JSON.stringify(body);
  } else if (body instanceof FormData) {
    opts.body = body;
  }
  const res = await fetch('/__dashboard' + path, opts);
  return res.json();
}

function toast(msg, dur = 2200) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), dur);
}

function relTime(ts) {
  if (!ts) return '—';
  const d = new Date(ts.includes('T') ? ts : ts + 'Z');
  const diff = Date.now() - d.getTime();
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
  return Math.floor(diff / 86400000) + 'd ago';
}

function fmtSize(b) {
  if (b < 1024) return b + ' B';
  if (b < 1048576) return (b / 1024).toFixed(1) + ' KB';
  return (b / 1048576).toFixed(1) + ' MB';
}

function esc(s) {
  return String(s ?? '')
    .replace(/&/g, '&amp;').replace(/</g, '&lt;')
    .replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

function openModal(id)  { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }

// ── Auth ──────────────────────────────────────────────────────────────────────
async function checkStatus() {
  const { setup } = await fetch('/__dashboard/status').then(r => r.json());
  if (!setup) {
    document.getElementById('auth-setup').style.display = '';
    setTimeout(() => document.getElementById('setup-pw').focus(), 50);
  } else {
    showLogin();
  }
}

function showLogin() {
  document.getElementById('auth-setup').style.display = 'none';
  document.getElementById('auth-login').style.display = '';
  document.getElementById('auth-forgot').style.display = 'none';
  setTimeout(() => document.getElementById('login-pw').focus(), 50);
}

function showForgot() {
  document.getElementById('auth-login').style.display = 'none';
  document.getElementById('auth-forgot').style.display = '';
  setTimeout(() => document.getElementById('forgot-phrase').focus(), 50);
}

async function doSetup() {
  const pw = document.getElementById('setup-pw').value;
  const r = await fetch('/__dashboard/setup', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pw }),
  }).then(r => r.json());
  if (r.ok) { pwd = pw; enterDashboard(); }
  else document.getElementById('setup-err').textContent = r.error || 'Error';
}

async function doLogin() {
  const pw = document.getElementById('login-pw').value;
  const r = await fetch('/__dashboard/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pw }),
  }).then(r => r.json());
  if (r.ok) { pwd = pw; enterDashboard(); }
  else document.getElementById('login-err').textContent = 'Incorrect password.';
}

async function doForgot() {
  const passphrase = document.getElementById('forgot-phrase').value;
  const password   = document.getElementById('forgot-pw').value;
  const r = await fetch('/__dashboard/forgot', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ passphrase, password }),
  }).then(r => r.json());
  if (r.ok) { pwd = password; enterDashboard(); }
  else document.getElementById('forgot-err').textContent = r.error || 'Error';
}

function logout() {
  pwd = '';
  document.getElementById('app').style.display = 'none';
  document.getElementById('auth-page').style.display = 'flex';
  document.getElementById('login-pw').value = '';
  document.getElementById('login-err').textContent = '';
  showLogin();
}

async function enterDashboard() {
  document.getElementById('auth-page').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('server-badge').textContent = window.location.origin;
  await Promise.all([loadRoutes(), loadCrons(), loadFiles()]);
}

// ── Tabs ──────────────────────────────────────────────────────────────────────
function showTab(tab) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('section-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
  if (tab === 'store') loadStore();
}

// ── Routes ────────────────────────────────────────────────────────────────────
async function loadRoutes() {
  routes = await api('/routes');
  renderRoutes();
}

function renderRoutes() {
  const wrap = document.getElementById('routes-wrap');
  document.getElementById('routes-count').textContent = routes.length ? `(${routes.length})` : '';
  if (!routes.length) {
    wrap.innerHTML = '<div class="empty-state">No routes yet. Create your first API endpoint.</div>';
    return;
  }
  wrap.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Method</th><th>Path</th><th>CORS</th><th>Rate Limit</th><th>Logging</th><th>Status</th><th></th>
    </tr></thead>
    <tbody>
    ${routes.map(r => `<tr>
      <td><span class="method method-${r.method}">${r.method}</span></td>
      <td class="mono sm">${esc(r.path)}</td>
      <td class="muted sm">${r.corsOrigin || '—'}</td>
      <td class="sm">${r.rateLimit?.enabled ? `${r.rateLimit.requests}/${r.rateLimit.window}${r.rateLimit.perIp ? ' · IP' : ''}` : '—'}</td>
      <td>${r.logging
        ? `<button class="btn-ghost sm" onclick="openLogs('${r.id}','${esc(r.method)} ${esc(r.path)}',false)">Logs</button>`
        : '<span class="muted sm">—</span>'}</td>
      <td>
        <label class="toggle">
          <input type="checkbox" ${r.enabled ? 'checked' : ''} onchange="toggleRoute('${r.id}',this.checked)">
          <span class="toggle-track"></span>
        </label>
      </td>
      <td><button class="btn-ghost sm" onclick="openRouteModal('${r.id}')">Edit</button></td>
    </tr>`).join('')}
    </tbody></table></div>`;
}

function openRouteModal(id) {
  editingRouteId = id || null;
  document.getElementById('r-cors-custom-row').style.display = 'none';
  document.getElementById('r-rl-fields').style.display = 'none';
  document.getElementById('r-delete-btn').style.display = 'none';

  if (id) {
    const r = routes.find(x => x.id === id);
    document.getElementById('route-modal-title').textContent = 'Edit Route';
    document.getElementById('r-method').value = r.method;
    document.getElementById('r-path').value = r.path;
    document.getElementById('r-code').value = r.code;
    document.getElementById('r-logging').checked = r.logging;
    document.getElementById('r-enabled').checked = r.enabled;
    document.getElementById('r-delete-btn').style.display = '';
    // CORS
    if (!r.corsOrigin) document.getElementById('r-cors').value = '';
    else if (r.corsOrigin === '*') document.getElementById('r-cors').value = '*';
    else {
      document.getElementById('r-cors').value = 'custom';
      document.getElementById('r-cors-custom-row').style.display = '';
      document.getElementById('r-cors-custom').value = r.corsOrigin;
    }
    // Rate limit
    if (r.rateLimit?.enabled) {
      document.getElementById('r-rl-enabled').checked = true;
      document.getElementById('r-rl-fields').style.display = '';
      document.getElementById('r-rl-req').value = r.rateLimit.requests;
      document.getElementById('r-rl-win').value = r.rateLimit.window;
      document.getElementById('r-rl-perip').checked = r.rateLimit.perIp;
    } else {
      document.getElementById('r-rl-enabled').checked = false;
    }
  } else {
    document.getElementById('route-modal-title').textContent = 'New Route';
    document.getElementById('r-method').value = 'GET';
    document.getElementById('r-path').value = '';
    document.getElementById('r-code').value = '';
    document.getElementById('r-cors').value = '';
    document.getElementById('r-logging').checked = false;
    document.getElementById('r-enabled').checked = true;
    document.getElementById('r-rl-enabled').checked = false;
    document.getElementById('r-rl-req').value = 100;
    document.getElementById('r-rl-win').value = '1m';
    document.getElementById('r-rl-perip').checked = false;
  }
  openModal('route-modal');
  setTimeout(() => document.getElementById('r-path').focus(), 50);
}

function toggleCorsCustom() {
  const v = document.getElementById('r-cors').value;
  document.getElementById('r-cors-custom-row').style.display = v === 'custom' ? '' : 'none';
}

function toggleRateLimit() {
  document.getElementById('r-rl-fields').style.display =
    document.getElementById('r-rl-enabled').checked ? '' : 'none';
}

async function saveRoute() {
  const corsVal = document.getElementById('r-cors').value;
  let corsOrigin = '';
  if (corsVal === '*') corsOrigin = '*';
  else if (corsVal === 'custom') corsOrigin = document.getElementById('r-cors-custom').value;

  const rlEnabled = document.getElementById('r-rl-enabled').checked;
  const rateLimit = rlEnabled ? {
    enabled: true,
    requests: parseInt(document.getElementById('r-rl-req').value) || 100,
    window: document.getElementById('r-rl-win').value || '1m',
    perIp: document.getElementById('r-rl-perip').checked,
  } : null;

  let pathValue = document.getElementById('r-path').value.trim();
  if (!pathValue.startsWith('/')) {
    pathValue = '/' + pathValue;
  }

  const data = {
    method: document.getElementById('r-method').value,
    path: pathValue,
    code: document.getElementById('r-code').value,
    corsOrigin, logging: document.getElementById('r-logging').checked,
    enabled: document.getElementById('r-enabled').checked,
    rateLimit,
  };

  if (editingRouteId) {
    await api('/routes/' + editingRouteId, 'PUT', data);
    toast('Route updated');
  } else {
    await api('/routes', 'POST', data);
    toast('Route created');
  }
  closeModal('route-modal');
  loadRoutes();
}

async function deleteRoute() {
  if (!confirm('Delete this route?')) return;
  await api('/routes/' + editingRouteId, 'DELETE');
  toast('Route deleted');
  closeModal('route-modal');
  loadRoutes();
}

async function toggleRoute(id, enabled) {
  await api('/routes/' + id, 'PATCH', { enabled });
  routes = routes.map(r => r.id === id ? { ...r, enabled } : r);
}

// ── Crons ─────────────────────────────────────────────────────────────────────
async function loadCrons() {
  crons = await api('/crons');
  renderCrons();
}

function renderCrons() {
  const wrap = document.getElementById('crons-wrap');
  document.getElementById('crons-count').textContent = crons.length ? `(${crons.length})` : '';
  if (!crons.length) {
    wrap.innerHTML = '<div class="empty-state">No cron jobs yet. Schedule background tasks.</div>';
    return;
  }
  wrap.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Name</th><th>Schedule</th><th>Last Run</th><th>Logging</th><th>Status</th><th></th>
    </tr></thead>
    <tbody>
    ${crons.map(c => `<tr>
      <td class="mono sm">${esc(c.name)}</td>
      <td class="mono sm">${esc(c.schedule)}</td>
      <td class="muted sm">${relTime(c.lastRun)}</td>
      <td>${c.logging
        ? `<button class="btn-ghost sm" onclick="openLogs('${c.id}','${esc(c.name)}',true)">Logs</button>`
        : '<span class="muted sm">—</span>'}</td>
      <td>
        <label class="toggle">
          <input type="checkbox" ${c.enabled ? 'checked' : ''} onchange="toggleCron('${c.id}',this.checked)">
          <span class="toggle-track"></span>
        </label>
      </td>
      <td class="actions">
        <button class="btn-ghost sm" onclick="runCronNow('${c.id}')" title="Run now">▶</button>
        <button class="btn-ghost sm" onclick="openCronModal('${c.id}')">Edit</button>
      </td>
    </tr>`).join('')}
    </tbody></table></div>`;
}

function openCronModal(id) {
  editingCronId = id || null;
  document.getElementById('c-delete-btn').style.display = 'none';
  if (id) {
    const c = crons.find(x => x.id === id);
    document.getElementById('cron-modal-title').textContent = 'Edit Cron Job';
    document.getElementById('c-name').value = c.name;
    document.getElementById('c-schedule').value = c.schedule;
    document.getElementById('c-code').value = c.code;
    document.getElementById('c-logging').checked = c.logging;
    document.getElementById('c-enabled').checked = c.enabled;
    document.getElementById('c-delete-btn').style.display = '';
  } else {
    document.getElementById('cron-modal-title').textContent = 'New Cron Job';
    document.getElementById('c-name').value = '';
    document.getElementById('c-schedule').value = '1h';
    document.getElementById('c-code').value = '';
    document.getElementById('c-logging').checked = false;
    document.getElementById('c-enabled').checked = true;
  }
  openModal('cron-modal');
}

async function saveCron() {
  const data = {
    name: document.getElementById('c-name').value,
    schedule: document.getElementById('c-schedule').value,
    code: document.getElementById('c-code').value,
    logging: document.getElementById('c-logging').checked,
    enabled: document.getElementById('c-enabled').checked,
  };
  if (editingCronId) {
    await api('/crons/' + editingCronId, 'PUT', data);
    toast('Cron updated');
  } else {
    await api('/crons', 'POST', data);
    toast('Cron created');
  }
  closeModal('cron-modal');
  loadCrons();
}

async function deleteCron() {
  if (!confirm('Delete this cron job?')) return;
  await api('/crons/' + editingCronId, 'DELETE');
  toast('Cron deleted');
  closeModal('cron-modal');
  loadCrons();
}

async function toggleCron(id, enabled) {
  await api('/crons/' + id, 'PATCH', { enabled });
  crons = crons.map(c => c.id === id ? { ...c, enabled } : c);
}

async function runCronNow(id) {
  await api('/crons/' + id + '/run', 'POST');
  toast('Cron triggered');
  setTimeout(loadCrons, 600);
}

// ── Logs ──────────────────────────────────────────────────────────────────────
function openLogs(id, title, isCron) {
  currentLogsApi = (isCron ? '/crons/' : '/routes/') + id + '/logs';
  document.getElementById('logs-title').textContent = 'Logs — ' + title;
  openModal('logs-modal');
  fetchLogs();
}

async function fetchLogs() {
  const data = await api(currentLogsApi);
  const list = document.getElementById('log-list');
  if (!data.length) {
    list.innerHTML = '<div class="empty-state">No logs yet.</div>';
    return;
  }
  list.innerHTML = data.map(l => `
    <div class="log-entry">
      <div class="log-meta">
        <span class="${l.status >= 400 ? 'log-err' : 'log-ok'}">${l.method} ${l.status}</span>
        · ${esc(l.path)} · <span title="${l.timestamp}">${relTime(l.timestamp)}</span>
      </div>
      ${l.response_body ? `<div class="log-body">${esc(l.response_body)}</div>` : ''}
    </div>
  `).join('');
}

async function clearLogs() {
  await api(currentLogsApi, 'DELETE');
  toast('Logs cleared');
  fetchLogs();
}

// ── Files ─────────────────────────────────────────────────────────────────────
async function loadFiles() {
  files = await api('/files');
  renderFiles();
}

function renderFiles() {
  const wrap = document.getElementById('files-wrap');
  document.getElementById('files-count').textContent = files.length ? `(${files.length})` : '';
  if (!files.length) {
    wrap.innerHTML = '<div class="empty-state">No files uploaded yet.</div>';
    return;
  }
  const origin = window.location.origin;
  wrap.innerHTML = `<div class="table-wrap"><table>
    <thead><tr>
      <th>Filename</th><th>URL</th><th>Type</th><th>Size</th><th>Uploaded</th><th></th>
    </tr></thead>
    <tbody>
    ${files.map(f => {
      const url = `${origin}/__u/${f.id}`;
      return `<tr>
        <td class="sm">${esc(f.filename)}</td>
        <td>
          <span class="file-url">${esc(url)}</span>
          <button class="btn-ghost sm" onclick="copyText('${esc(url)}')" style="margin-left:4px">Copy</button>
        </td>
        <td class="muted sm">${esc(f.mimetype)}</td>
        <td class="muted sm">${fmtSize(f.size)}</td>
        <td class="muted sm">${relTime(f.created_at)}</td>
        <td><button class="btn-ghost-danger sm" onclick="deleteFile('${f.id}')">Delete</button></td>
      </tr>`;
    }).join('')}
    </tbody></table></div>`;
}

function handleDrop(e) {
  e.preventDefault();
  document.getElementById('upload-zone').classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file) uploadFile(file);
}

function handleFileSelect(file) {
  if (file) uploadFile(file);
}

async function uploadFile(file) {
  const status = document.getElementById('upload-status');
  status.style.display = '';
  status.textContent = `Uploading ${file.name}…`;

  const fd = new FormData();
  fd.append('file', file);

  const res = await fetch('/__dashboard/files', {
    method: 'POST',
    headers: { 'X-Password': pwd },
    body: fd,
  });
  const data = await res.json();

  if (data.id) {
    const url = window.location.origin + '/__u/' + data.id;
    status.textContent = `Done! ${url}`;
    navigator.clipboard.writeText(url).catch(() => {});
    toast('Uploaded — URL copied to clipboard');
    loadFiles();
    setTimeout(() => closeModal('upload-modal'), 1800);
  } else {
    status.textContent = 'Upload failed: ' + (data.error || 'Unknown error');
  }
}

async function deleteFile(id) {
  if (!confirm('Delete this file?')) return;
  await api('/files/' + id, 'DELETE');
  toast('File deleted');
  loadFiles();
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(() => toast('Copied!')).catch(() => {});
}

// ── Store ─────────────────────────────────────────────────────────────────────
async function loadStore() {
  const cols = await api('/store');
  const wrap = document.getElementById('store-wrap');
  if (!cols.length) {
    wrap.innerHTML = '<div class="empty-state">No store data yet. Use <code style="font-family:var(--mono);font-size:12px;background:var(--gray-100);padding:1px 5px;border-radius:3px">store.set()</code> in a route or cron.</div>';
    return;
  }
  wrap.innerHTML = `<div class="table-wrap"><table>
    <thead><tr><th>Collection</th><th>Entries</th><th></th></tr></thead>
    <tbody>
    ${cols.map(c => `<tr>
      <td class="mono sm">${esc(c.collection)}</td>
      <td class="muted sm">${c.count}</td>
      <td class="actions">
        <button class="btn-ghost sm" onclick="openCollection(${JSON.stringify(c.collection)})">Browse</button>
        <button class="btn-ghost-danger sm" onclick="dropCollection(${JSON.stringify(c.collection)})">Drop</button>
      </td>
    </tr>`).join('')}
    </tbody></table></div>`;
}

async function openCollection(col) {
  const entries = await api('/store/' + encodeURIComponent(col));
  const wrap = document.getElementById('store-wrap');
  wrap.innerHTML = `
    <div class="breadcrumb">
      <span class="crumb" onclick="loadStore()">Store</span>
      <span class="muted">›</span>
      <span>${esc(col)}</span>
    </div>
    ${entries.length ? `<div class="table-wrap"><table>
      <thead><tr><th>Key</th><th>Value</th><th>Updated</th><th></th></tr></thead>
      <tbody>
      ${entries.map(e => `<tr>
        <td class="mono sm">${esc(e.key)}</td>
        <td class="mono sm" style="max-width:320px;word-break:break-all">${esc(JSON.stringify(e.value).slice(0, 200))}</td>
        <td class="muted sm">${relTime(e.updated_at)}</td>
        <td><button class="btn-ghost-danger sm" onclick="deleteEntry(${JSON.stringify(col)},${JSON.stringify(e.key)})">Delete</button></td>
      </tr>`).join('')}
      </tbody></table></div>`
    : '<div class="empty-state">No entries in this collection.</div>'}`;
}

async function dropCollection(col) {
  if (!confirm(`Drop collection "${col}"? This cannot be undone.`)) return;
  await api('/store/' + encodeURIComponent(col), 'DELETE');
  toast('Collection dropped');
  loadStore();
}

async function deleteEntry(col, key) {
  await api('/store/' + encodeURIComponent(col) + '/' + encodeURIComponent(key), 'DELETE');
  toast('Entry deleted');
  openCollection(col);
}

// ── Keyboard shortcuts ────────────────────────────────────────────────────────
document.addEventListener('keydown', e => {
  if (e.key === 'Tab' && e.target.tagName === 'TEXTAREA') {
    e.preventDefault();
    const t = e.target, s = t.selectionStart;
    t.value = t.value.slice(0, s) + '  ' + t.value.slice(t.selectionEnd);
    t.selectionStart = t.selectionEnd = s + 2;
  }
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal-overlay.open').forEach(m => m.classList.remove('open'));
  }
});

document.querySelectorAll('.modal-overlay').forEach(el => {
  el.addEventListener('click', e => { if (e.target === el) closeModal(el.id); });
});

// ── Init ──────────────────────────────────────────────────────────────────────
checkStatus();
</script>
</body>
</html>
